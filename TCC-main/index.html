<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Sistema de Agendamento de Turmas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="css/style.css">
</head>

<body class="bg-gray-50 p-6">

  <div id="loader" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <div class="max-w-full mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
        Sistema de Agendamento de Turmas
      </h1>

      <!-- Barra superior (m√©dio/compacta) -->
      <div id="top-toolbar" class="mb-6 space-y-2">
        <!-- Linha 1: A√ß√µes principais -->
        <div class="flex flex-wrap items-center gap-2">

          <!-- Grupo: a√ß√µes principais -->
          <button id="btn-add-lessons"
            class="flex items-center gap-1 h-9 px-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md text-sm font-medium shadow-sm">
            Adicionar Aula
          </button>

          <button id="btn-editar"
            class="flex items-center gap-1 h-9 px-3 bg-amber-600 hover:bg-amber-700 text-white rounded-md text-sm font-medium shadow-sm disabled:opacity-40 disabled:cursor-not-allowed"
            disabled>
            Editar Aula
          </button>

          <button id="btn-recarregar"
            class="flex items-center gap-1 h-9 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium shadow-sm">
            Recarregar
          </button>

          <!-- Grupo: selecionar e carregar hor√°rio -->
          <div class="flex items-center gap-2 bg-gray-100 border border-gray-200 rounded-md h-9 pl-2 pr-2">
            <select id="ed-saved-select"
              class="border-0 bg-transparent text-sm px-1 py-0.5 min-w-[240px] focus:outline-none">
              <option>Hor√°rios salvos...</option>
            </select>

            <button id="ed-load-saved"
              class="h-7 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium">
              Carregar
            </button>

            <button id="ed-delete-saved"
              class="h-7 px-3 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-medium"
              title="Excluir hor√°rio salvo">
              Excluir
            </button>
          </div>

          <!-- √Ä direita do seletor -->
          <button id="btn-salvar"
            class="flex items-center gap-1 h-9 px-3 bg-orange-600 hover:bg-orange-700 text-white rounded-md text-sm font-medium shadow-sm">
            Salvar
          </button>

          <button id="btn-compartilhar"
            class="flex items-center gap-1 h-9 px-3 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium shadow-sm">
            Compartilhar
          </button>

          <!-- Zoom no final da linha -->
          <div class="flex items-center gap-1 ml-auto">
            <span class="text-xs text-gray-600 mr-1">Zoom:</span>
            <button id="btn-zoom-out" class="h-8 px-2 bg-gray-200 hover:bg-gray-300 rounded text-sm">‚Äì</button>
            <button id="btn-zoom-reset" class="h-8 px-2 bg-gray-200 hover:bg-gray-300 rounded text-sm">100%</button>
            <button id="btn-zoom-in" class="h-8 px-2 bg-gray-200 hover:bg-gray-300 rounded text-sm">+</button>
            <span id="zoom-indicator" class="text-xs text-gray-600 w-10 text-center">100%</span>
          </div>
        </div>

        <!-- Linha 2: Datas e envio -->
        <div class="flex flex-wrap items-center gap-3 mt-2">
          <div class="flex items-center gap-3">
            <label class="text-xs text-gray-700">In√≠cio:</label>
            <input id="dt-inicio" type="date" class="h-9 border rounded-md px-2 text-sm w-32" />
            <label class="text-xs text-gray-700">Fim:</label>
            <input id="dt-fim" type="date" class="h-9 border rounded-md px-2 text-sm w-32" />
          </div>

          <button id="btn-enviar-mrbs"
            class="h-9 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm font-semibold shadow-sm">
            Enviar para Reservas
          </button>
        </div>
      </div>




      <div class="grid-scroller">
        <!-- Legenda -->
        <div class="flex items-center gap-6 mb-4 justify-start flex-wrap">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-white border border-gray-300 rounded"></div>
            <span class="text-sm text-gray-600">Dispon√≠vel</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-red-200 rounded"></div>
            <span class="text-sm text-gray-600">Ocupado</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-6 h-3 bg-green-500 rounded text-xs"></div>
            <span class="text-sm text-gray-600">Manh√£ (08:00-12:00)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-6 h-3 bg-yellow-500 rounded"></div>
            <span class="text-sm text-gray-600">Tarde (13:30-17:30)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-6 h-3 bg-purple-500 rounded"></div>
            <span class="text-sm text-gray-600">Noite (19:00-22:10)</span>
          </div>
        </div>

        <!-- ‚¨áÔ∏è Wrapper do zoom -->
        <div id="grid-zoom-wrapper" class="zoomable">
          <div id="grid-zoom-inner" class="zoomable__inner">

            <!-- Cabe√ßalho dos dias -->
            <div class="turma-row mb-4">
              <div class="bg-gray-800 text-white p-3 font-bold text-center rounded-lg">TURMAS</div>
              <div class="bg-blue-600 text-white p-3 font-bold text-center rounded-lg header-day">SEGUNDA-FEIRA</div>
              <div class="bg-blue-600 text-white p-3 font-bold text-center rounded-lg header-day">TER√áA-FEIRA</div>
              <div class="bg-blue-600 text-white p-3 font-bold text-center rounded-lg header-day">QUARTA-FEIRA</div>
              <div class="bg-blue-600 text-white p-3 font-bold text-center rounded-lg header-day">QUINTA-FEIRA</div>
              <div class="bg-blue-600 text-white p-3 font-bold text-center rounded-lg header-day">SEXTA-FEIRA</div>
              <div class="bg-blue-600 text-white p-3 font-bold text-center rounded-lg header-day">S√ÅBADO</div>
            </div>

            <!-- Cabe√ßalho dos per√≠odos -->
            <div id="periods-header" class="turma-row mb-2">
              <div class="bg-gray-200 p-2 text-center text-sm font-medium">PER√çODOS</div>
            </div>

            <!-- Grade -->
            <div id="schedule-grid"></div>
          </div>
        </div>
        <!-- ‚¨ÜÔ∏è Fim do wrapper -->
      </div>

      <!-- Painel inferior (n√£o alocadas) -->
      <div id="unalloc-panel" class="unalloc-sticky mt-8 border-t border-gray-200 bg-gray-50 rounded-t-lg">

        <!-- Cabe√ßalho fixo fora da √°rea rol√°vel -->
        <div class="unalloc-header flex items-center justify-between px-4 py-2">
          <h2 class="text-lg font-semibold">Aulas n√£o alocadas</h2>
          <span id="unalloc-count" class="text-sm text-gray-600"></span>
        </div>

        <!-- √Årea rol√°vel das aulas -->
        <div class="unalloc-sticky-inner p-4 pt-2">
          <div id="unallocated-list" class="flex flex-wrap gap-2"></div>
          <div class="text-xs text-gray-500 mt-3 leading-relaxed">
            Selecione um cart√£o e depois clique em um espa√ßo vazio na grade para alocar
            (respeita a dura√ß√£o e turma).<br />
            Clique duas vezes em um cart√£o de aula para <b>remover</b> a aula da grade.
          </div>
        </div>
      </div>

    </div>
  </div>


  <!-- Modal Editar Aula -->
  <div id="edit-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-lg rounded-xl shadow-xl p-5">
      <h3 class="text-xl font-semibold mb-4">Editar aula</h3>

      <div class="space-y-3">
        <!-- Mat√©ria -->
        <label class="block text-sm">
          <span class="text-gray-700">Mat√©ria</span>
          <select id="em-subject" class="mt-1 w-full border rounded px-2 py-1"></select>
        </label>

        <!-- Professores (multi-select) -->
        <label class="block text-sm">
          <span class="text-gray-700">Professor(es)</span>
          <select id="em-teachers" class="mt-1 w-full border rounded px-2 py-1" multiple size="5"></select>
          <div class="mt-2">
            <button id="em-add-teacher" type="button"
              class="px-2 py-1 text-xs rounded bg-emerald-600 hover:bg-emerald-700 text-white">
              + Novo professor
            </button>
          </div>
          <span class="text-xs text-gray-500">Segure Ctrl (ou Cmd no Mac) para selecionar v√°rios.</span>
        </label>

        <!-- Sala -->
        <label class="block text-sm">
          <span class="text-gray-700">Sala</span>
          <select id="em-room" class="mt-1 w-full border rounded px-2 py-1">
            <option value="">(sem sala)</option>
          </select>
        </label>

        <!-- Dura√ß√£o -->
        <label class="block text-sm">
          <span class="text-gray-700">Dura√ß√£o (per√≠odos)</span>
          <input id="em-duration" type="number" min="1" class="mt-1 w-32 border rounded px-2 py-1" />
        </label>
      </div>

      <div class="mt-5 flex justify-end gap-2">
        <button id="em-cancel" class="px-3 py-1 rounded border">Cancelar</button>
        <button id="em-save" class="px-3 py-1 rounded bg-blue-600 text-white">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar Aulas -->
  <div id="add-lessons-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-2xl rounded-xl shadow-xl p-5">
      <h3 class="text-xl font-semibold mb-4">Adicionar aulas (v√£o para "N√£o alocadas")</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Turma -->
        <label class="block text-sm col-span-1 md:col-span-2">
          <span class="text-gray-700">Turma</span>
          <select id="al-class" class="mt-1 w-full border rounded px-2 py-1"></select>
        </label>

        <!-- Mat√©ria -->
        <div class="col-span-1">
          <span class="block text-sm text-gray-700 mb-1">Mat√©ria</span>
          <div class="flex items-center gap-4 text-sm mb-2">
            <label class="inline-flex items-center gap-1">
              <input type="radio" name="al-subj-mode" value="existing" checked>
              <span>Usar existente</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input type="radio" name="al-subj-mode" value="new">
              <span>Criar nova</span>
            </label>
          </div>

          <div id="al-subj-existing">
            <select id="al-subject-select" class="w-full border rounded px-2 py-1"></select>
          </div>

          <div id="al-subj-new" class="hidden space-y-2">
            <input id="al-subject-name" type="text" placeholder="Nome da mat√©ria"
              class="w-full border rounded px-2 py-1">
            <input id="al-subject-abbr" type="text" placeholder="Abrevia√ß√£o (opcional)"
              class="w-40 border rounded px-2 py-1">
          </div>
        </div>

        <!-- Professor(es) -->
        <div class="col-span-1">
          <span class="block text-sm text-gray-700 mb-1">Professor(es)</span>
          <div class="flex items-center gap-4 text-sm mb-2">
            <label class="inline-flex items-center gap-1">
              <input type="radio" name="al-teach-mode" value="existing" checked>
              <span>Usar existentes</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input type="radio" name="al-teach-mode" value="new">
              <span>Criar novo</span>
            </label>
          </div>

          <div id="al-teach-existing">
            <select id="al-teachers-select" multiple size="6" class="w-full border rounded px-2 py-1"></select>
            <div class="text-xs text-gray-500 mt-1">Use Ctrl/Cmd para escolher v√°rios.</div>
          </div>

          <div id="al-teach-new" class="hidden space-y-2">
            <input id="al-teacher-name" type="text" placeholder="Nome do professor"
              class="w-full border rounded px-2 py-1">
            <input id="al-teacher-id" type="text" placeholder="ID curto (opcional)"
              class="w-48 border rounded px-2 py-1">
            <div class="text-xs text-gray-500">Se deixar o ID vazio, geramos automaticamente.</div>
          </div>
        </div>

        <!-- Sala -->
        <label class="block text-sm">
          <span class="text-gray-700">Sala (opcional)</span>
          <select id="al-room" class="mt-1 w-full border rounded px-2 py-1">
            <option value="">(sem sala)</option>
          </select>
        </label>

        <!-- Dura√ß√£o -->
        <label class="block text-sm">
          <span class="text-gray-700">Dura√ß√£o (per√≠odos)</span>
          <input id="al-duration" type="number" min="1" value="1" class="mt-1 w-32 border rounded px-2 py-1">
        </label>

        <!-- Quantidade -->
        <label class="block text-sm">
          <span class="text-gray-700">Quantidade de cards</span>
          <input id="al-qty" type="number" min="1" max="50" value="1" class="mt-1 w-32 border rounded px-2 py-1">
        </label>

      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button id="al-cancel" class="px-3 py-1 rounded border">Cancelar</button>
        <button id="al-save" class="px-3 py-1 rounded bg-emerald-600 text-white">Adicionar</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-[9999]"></div>



  <!-- Scripts -->
  <!-- Adaptador
  <script src="js/ag-adapter.js"></script>

  Placeholder local (meta/days/periods)
  <script src="js/data.js"></script>

  Carrega AG payload e injeta app.js
  <script>
    (async function () {
      const AG_BASE = "http://localhost:9001";
      const loader = document.getElementById('loader');
      loader.classList.remove('hidden');

      try {
        const r = await fetch(`${AG_BASE}/api/latest`, { credentials: "omit" });
        if (r.ok) {
          window.AG_PAYLOAD = await r.json();
        }
      } catch (e) {
        console.warn("AG n√£o dispon√≠vel, usando data.js:", e);
      } finally {
        loader.classList.add('hidden');
      }

      const s = document.createElement('script');
      s.src = "js/app.js";
      document.body.appendChild(s);
    })();
  </script> -->

  <script src="js/ag-adapter.js"></script>
  <script src="js/data.js"></script>

  <script>
    (async () => {
      if (!window.EDITOR_DATA?.meta) {
        await new Promise(r => setTimeout(r, 50));
      }

      async function listSavedEditor() {
        try {
          const r = await fetch(`${location.origin}/FrontTCC/api/list_schedules.php?v=${Date.now()}`, { cache: 'no-store' });
          const data = await r.json();
          // Normaliza para array de itens
          if (Array.isArray(data)) return data;
          if (data && Array.isArray(data.files)) return data.files;
          if (data && Array.isArray(data.items)) return data.items;
          return [];
        } catch {
          return [];
        }
      }

      async function getSavedEditor(fileName) {
        const url = `${location.origin}/FrontTCC/api/get_schedule.php?file=${encodeURIComponent(fileName)}`;
        const resp = await fetch(url, { cache: 'no-store' });
        const json = await resp.json();
        if (!resp.ok || json?.ok === false) throw new Error(json?.error || `HTTP ${resp.status}`);
        return json.data || json;
      }

      function pickLatest(items) {
        if (!items.length) return null;
        // pega maior savedAt; se n√£o existir savedAt, usa o √∫ltimo da lista
        const withDate = items.filter(it => typeof it.savedAt === 'string');
        if (withDate.length) {
          return withDate.reduce((a, b) => (new Date(a.savedAt) > new Date(b.savedAt) ? a : b));
        }
        return items[items.length - 1];
      }

      async function loadLatestFromAPI() {
        const list = await listSavedEditor();
        // DEBUG opcional:
        console.log('[boot] lista recebida:', list);

        const latestItem = pickLatest(list);
        if (!latestItem?.file) {
          console.warn('‚ö†Ô∏è Nenhum arquivo salvo. Usando placeholders.');
          return { cons: null, file: '(placeholders)' };
        }

        console.log(`‚úÖ Carregando hor√°rio da API: ${latestItem.file}`);
        const cons = await getSavedEditor(latestItem.file);
        return { cons, file: latestItem.file };
      }

      const { cons, file } = await loadLatestFromAPI();
      window.__bootConsolidated = cons;
      window.__bootLoadedName = file;

      const s = document.createElement('script');
      s.src = 'js/app.js';
      document.body.appendChild(s);
    })();
  </script>



  <script>
    (() => {
      // Evita inicializar 2x
      if (window.__GRID_ZOOM_INIT__) return;
      window.__GRID_ZOOM_INIT__ = true;

      const STEP = 0.1;          // 10% por clique
      const Z_MIN = 0.5, Z_MAX = 1.0;

      const inner = () => document.getElementById('grid-zoom-inner');
      const indic = () => document.getElementById('zoom-indicator');

      let z = 1;                 // <-- sempre come√ßa em 100% a cada reload

      const clamp = v => Math.max(Z_MIN, Math.min(Z_MAX, v));

      function apply() {
        const i = inner();
        if (!i) return;
        i.style.transform = `scale(${z})`;
        const zi = indic();
        if (zi) zi.textContent = `${Math.round(z * 100)}%`;
      }

      // Come√ßa em 100% sempre
      window.addEventListener('load', () => {
        z = 1;
        apply();
      });

      // Trata bot√µes e bloqueia handlers duplicados
      document.addEventListener('click', (e) => {
        const id = e.target && e.target.id;
        if (!['btn-zoom-out', 'btn-zoom-in', 'btn-zoom-reset'].includes(id)) return;

        e.preventDefault();
        e.stopImmediatePropagation();

        if (id === 'btn-zoom-out') z = clamp(z - STEP);
        else if (id === 'btn-zoom-in') z = clamp(z + STEP);
        else z = 1;    // reset

        apply();
      }, true);
    })();
  </script>

  <script>
    (function () {
      const ENDPOINT = "http://localhost:8080/FrontTCC/api/mrbs_import.php";

      async function getCurrentScheduleForSending() {
        // USA A MESMA FUN√á√ÉO QUE O BOT√ÉO SALVAR
        if (typeof buildConsolidated === 'function') {
          const consolidated = buildConsolidated();

          if (!consolidated?.allocations?.length) {
            alert("‚ö†Ô∏è N√£o h√° aulas alocadas na grade!");
            return null;
          }

          console.log("üìä Enviando da grade:", consolidated.allocations.length, "aulas");
          return {
            meta: consolidated.meta,
            classes: consolidated.classes,
            teachers: consolidated.teachers,
            subjects: consolidated.subjects,
            rooms: consolidated.rooms,
            allocations: consolidated.allocations
          };
        }

        alert("‚ùå Fun√ß√£o buildConsolidated n√£o encontrada.");
        return null;
      }

      async function enviarParaMRBS() {
        const dtInicio = document.getElementById('dt-inicio').value;
        const dtFim = document.getElementById('dt-fim').value;
        if (!dtInicio || !dtFim) {
          alert("Informe a data de in√≠cio e fim do semestre.");
          return;
        }

        const sched = await getCurrentScheduleForSending();
        if (!sched) return;

        const payload = {
          tz: "America/Sao_Paulo",
          start_date: dtInicio,
          end_date: dtFim,
          meta: { periods: sched.meta.periods },
          classes: sched.classes,
          teachers: sched.teachers,
          subjects: sched.subjects,
          rooms: sched.rooms,
          allocations: sched.allocations
        };

        try {
          const r = await fetch(ENDPOINT + '?nocache=' + Date.now(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const resp = await r.json().catch(() => ({}));
          if (!r.ok || !resp.ok) {
            console.error("Falha MRBS", r.status, resp);
            alert("Falha ao enviar para o MRBS. Verifique o console.");
            return;
          }

          alert(`‚úÖ MRBS: ${resp.inserted} reservas inseridas, ${resp.skipped} puladas.`);

          // Debug info no console
          if (resp.debug_info) {
            console.log("üîç Debug MRBS:", resp.debug_info);
          }
          if (resp.class_mappings) {
            console.log("üéØ Mapeamentos por turma:", resp.class_mappings);
          }

        } catch (e) {
          console.error(e);
          alert("Erro de rede ao enviar para o MRBS.");
        }
      }

      document.getElementById("btn-enviar-mrbs")?.addEventListener("click", enviarParaMRBS);

      // Debug helper
      console.log("‚úÖ Bot√£o enviar-MRBS configurado com buildConsolidated");
    })();
  </script>


  <!-- FAB Editar (fora de wrappers com transform) -->
  <div id="edit-fab" class="fixed bottom-16 right-8 z-[10000]">
    <button id="fab-edit"
      class="flex items-center gap-2 px-5 py-3 rounded-full bg-amber-600 hover:bg-amber-700 text-white text-base font-semibold shadow-xl ring-1 ring-amber-700/30">
      Editar aula
    </button>
  </div>

  <script>
    (() => {
      const $fabWrap = document.getElementById('edit-fab');
      const $fabBtn = document.getElementById('fab-edit');
      const $btnTopo = document.getElementById('btn-editar');
      if (!$fabWrap || !$fabBtn || !$btnTopo) return;

      // 1) N√£o deixe o "clique fora" cancelar a sele√ß√£o quando clicamos no FAB
      document.addEventListener('pointerdown', (e) => {
        if (e.target.closest?.('#edit-fab')) {
          e.stopPropagation();
        }
      }, true);

      // 2) Sincroniza a visibilidade do FAB com o estado do bot√£o do topo
      function syncFab() {
        const hidden = !!$btnTopo.disabled;
        $fabWrap.classList.toggle('hidden', hidden);
      }
      new MutationObserver(syncFab).observe($btnTopo, { attributes: true, attributeFilter: ['disabled'] });
      window.addEventListener('load', syncFab);

      // 3) Clique no FAB: chama diretamente a fun√ß√£o global do app, se existir.
      //    Se n√£o existir, emula um click real no bot√£o do topo como fallback.
      $fabBtn.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();

        // tenta a fun√ß√£o global (alguns projetos exp√µem algo assim)
        if (typeof window.openEditModal === 'function') {
          window.openEditModal();
          return;
        }

        // fallback: disparo de clique "real" no bot√£o do topo
        if (!$btnTopo.disabled) {
          const evt = new MouseEvent('click', { bubbles: true, cancelable: true, view: window });
          $btnTopo.dispatchEvent(evt);
        }
      });

      // 4) Se o app alterar o estado de sele√ß√£o por ESC/click fora, re-sincroniza
      document.addEventListener('keydown', () => setTimeout(syncFab, 0), true);
      document.addEventListener('click', () => setTimeout(syncFab, 0), true);

      // 5) Logs r√°pidos para depura√ß√£o (pode remover depois)
      new MutationObserver((muts) => {
        muts.forEach(() => console.log('[FAB] btn-editar disabled =', $btnTopo.disabled));
      }).observe($btnTopo, { attributes: true, attributeFilter: ['disabled'] });
    })();
  </script>

</body>

</html>